# Feature Implementation Plan: Multi-Tenancy & Authentication System

## Executive Summary

This plan outlines the implementation of the foundational multi-tenancy and authentication system for the creator economy platform. The system enables secure tenant isolation, flexible authentication methods, and role-based access control across organizations. This is the critical path feature that enables all other platform functionality.

## Feature Breakdown

### User Stories

**As a platform administrator**, I want to manage multiple organizations, so that I can serve different clients and projects.

**As an organization owner**, I want to invite team members with specific roles, so that I can collaborate while maintaining security.

**As a team member**, I want to access only the organizations I'm authorized for, so that I can work efficiently without seeing irrelevant data.

**As a visitor**, I want to access organization pages via custom domains or subdomains, so that I can interact with the brand seamlessly.

**As a user**, I want to authenticate via multiple methods (OAuth, email, magic links), so that I can use my preferred login method.

## Implementation Phases

### Phase 1: Core Multi-Tenancy (MVP) - **L**
- Tenant resolution middleware
- Database schema with tenant isolation
- Basic organization management
- Simple authentication (email/password)

### Phase 2: Enhanced Authentication - **M**
- OAuth providers integration
- Magic link authentication
- Role-based access control
- Team invitation system

### Phase 3: Advanced Features - **L**
- Custom domain mapping
- SSL certificate management
- Advanced permission system
- Audit logging

## Technical Approach

### Next.js 15 Patterns
- **Middleware**: Tenant resolution and authentication checks
- **Server Actions**: Form handling for authentication
- **Route Handlers**: API endpoints for auth flows
- **Server Components**: Default rendering with client components for interactivity

### Component Architecture
```
src/components/auth/
├── forms/
│   ├── login-form.tsx
│   ├── register-form.tsx
│   └── magic-link-form.tsx
├── providers/
│   ├── auth-provider.tsx
│   └── tenant-provider.tsx
└── guards/
    ├── auth-guard.tsx
    └── role-guard.tsx
```

### State Management Strategy
- **Server State**: User session, tenant context, organization data
- **Client State**: Form state, UI interactions, temporary data
- **Caching**: Redis for session storage, database query caching

### Data Fetching Patterns
- **Server Components**: Initial data loading
- **Server Actions**: Form submissions and mutations
- **Streaming**: Progressive loading for dashboard data

### Form Handling
- **Server Actions**: Authentication forms
- **react-hook-form**: Client-side validation
- **Zod**: Schema validation and type safety

## File Structure

```
src/
├── app/
│   ├── (auth)/
│   │   ├── login/
│   │   │   └── page.tsx
│   │   ├── register/
│   │   │   └── page.tsx
│   │   ├── magic-link/
│   │   │   └── page.tsx
│   │   └── layout.tsx
│   ├── (dashboard)/
│   │   ├── [organization]/
│   │   │   ├── dashboard/
│   │   │   ├── settings/
│   │   │   │   ├── members/
│   │   │   │   └── page.tsx
│   │   │   └── layout.tsx
│   │   └── layout.tsx
│   ├── api/
│   │   ├── auth/
│   │   │   ├── signin/
│   │   │   ├── signup/
│   │   │   ├── oauth/
│   │   │   └── magic-link/
│   │   ├── organizations/
│   │   │   ├── route.ts
│   │   │   └── [id]/
│   │   │       ├── members/
│   │   │       └── route.ts
│   │   └── tenants/
│   │       └── resolve/
│   │           └── route.ts
│   └── [domain]/
│       └── page.tsx
├── components/
│   ├── auth/
│   │   ├── forms/
│   │   ├── providers/
│   │   └── guards/
│   └── ui/
├── lib/
│   ├── auth.ts
│   ├── tenant.ts
│   ├── db.ts
│   └── validations/
│       ├── auth.ts
│       └── organization.ts
├── middleware.ts
└── types/
    ├── auth.ts
    ├── tenant.ts
    └── organization.ts
```

## Database Schema Updates

### Core Tables
```sql
-- Users (global)
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  avatar_url TEXT,
  email_verified BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Organizations (tenants)
CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  slug VARCHAR(100) UNIQUE NOT NULL,
  custom_domain VARCHAR(255) UNIQUE,
  ssl_verified BOOLEAN DEFAULT FALSE,
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Organization memberships
CREATE TABLE organization_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role VARCHAR(50) NOT NULL CHECK (role IN ('owner', 'admin', 'editor', 'viewer')),
  permissions JSONB DEFAULT '{}',
  invited_by UUID REFERENCES users(id),
  joined_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(organization_id, user_id)
);

-- User sessions
CREATE TABLE user_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  token VARCHAR(255) UNIQUE NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Indexes
```sql
CREATE INDEX idx_organizations_slug ON organizations(slug);
CREATE INDEX idx_organizations_custom_domain ON organizations(custom_domain);
CREATE INDEX idx_organization_members_user ON organization_members(user_id);
CREATE INDEX idx_organization_members_org ON organization_members(organization_id);
CREATE INDEX idx_user_sessions_token ON user_sessions(token);
CREATE INDEX idx_user_sessions_user ON user_sessions(user_id);
```

## API Endpoint Specifications

### Authentication Routes
```typescript
// POST /api/auth/signin
interface SignInRequest {
  email: string;
  password: string;
  organization?: string; // Optional tenant context
}

interface SignInResponse {
  user: User;
  session: Session;
  organization?: Organization;
}

// POST /api/auth/signup
interface SignUpRequest {
  email: string;
  password: string;
  name: string;
  organizationName?: string; // Create organization on signup
}

// POST /api/auth/magic-link
interface MagicLinkRequest {
  email: string;
  organization?: string;
}

// GET /api/auth/session
interface SessionResponse {
  user: User | null;
  organization: Organization | null;
  permissions: Permission[];
}
```

### Organization Routes
```typescript
// GET /api/organizations
interface OrganizationsResponse {
  organizations: Organization[];
}

// POST /api/organizations
interface CreateOrganizationRequest {
  name: string;
  slug: string;
  description?: string;
}

// POST /api/organizations/[id]/members
interface InviteMemberRequest {
  email: string;
  role: 'admin' | 'editor' | 'viewer';
  message?: string;
}
```

### Tenant Resolution
```typescript
// GET /api/tenants/resolve?domain=example.com
interface TenantResolutionResponse {
  organization: Organization | null;
  isCustomDomain: boolean;
  redirectUrl?: string;
}
```

## Component Wireframes

### Login Page
```
┌─────────────────────────────────────┐
│              Login Form             │
├─────────────────────────────────────┤
│  Email: [________________]          │
│  Password: [____________]           │
│  Organization: [Dropdown]          │
│                                     │
│  [Sign In] [Magic Link]             │
│                                     │
│  ───────── OR ─────────             │
│                                     │
│  [Google] [GitHub] [Twitter]        │
│                                     │
│  Don't have account? [Sign Up]      │
└─────────────────────────────────────┘
```

### Organization Dashboard
```
┌─────────────────────────────────────┐
│  [Logo] Organization Name    [User] │
├─────────────────────────────────────┤
│  Dashboard | Pages | Products | ...  │
├─────────────────────────────────────┤
│                                     │
│  Welcome to [Organization]          │
│                                     │
│  Quick Actions:                     │
│  [Create Page] [Add Product]        │
│                                     │
│  Recent Activity:                   │
│  • Page "About" published           │
│  • New member invited               │
│                                     │
└─────────────────────────────────────┘
```

## Third-Party Libraries

### Required Packages
```json
{
  "next-auth": "^5.0.0-beta.4",
  "react-hook-form": "^7.48.2",
  "zod": "^3.22.4",
  "@hookform/resolvers": "^3.3.2",
  "bcryptjs": "^2.4.3",
  "jsonwebtoken": "^9.0.2",
  "nodemailer": "^6.9.7",
  "redis": "^4.6.10",
  "pg": "^8.11.3",
  "@types/bcryptjs": "^2.4.6",
  "@types/jsonwebtoken": "^9.0.5",
  "@types/nodemailer": "^6.4.14"
}
```

### Alternative Options
- **Auth**: Clerk (easier setup) vs NextAuth.js (more control)
- **Forms**: react-hook-form vs Formik (react-hook-form preferred for performance)
- **Validation**: Zod vs Yup (Zod preferred for TypeScript integration)

### Bundle Size Considerations
- NextAuth.js: ~50KB (tree-shakeable)
- react-hook-form: ~25KB
- Zod: ~15KB
- Total auth bundle: ~90KB (acceptable for auth functionality)

## Testing Strategy

### Unit Tests (Vitest)
```typescript
// lib/auth.test.ts
describe('Authentication', () => {
  test('should hash password correctly', () => {
    // Test password hashing
  });
  
  test('should validate email format', () => {
    // Test email validation
  });
  
  test('should generate secure tokens', () => {
    // Test token generation
  });
});
```

### Integration Tests (Vitest + Test Database)
```typescript
// __tests__/auth.integration.test.ts
describe('Auth API Routes', () => {
  test('POST /api/auth/signin should authenticate user', async () => {
    // Test signin flow
  });
  
  test('POST /api/auth/signup should create user and organization', async () => {
    // Test signup flow
  });
});
```

### E2E Tests (Playwright)
```typescript
// tests/auth.spec.ts
test('User can sign up and create organization', async ({ page }) => {
  await page.goto('/register');
  await page.fill('[name="email"]', 'test@example.com');
  await page.fill('[name="password"]', 'password123');
  await page.fill('[name="organizationName"]', 'Test Org');
  await page.click('[type="submit"]');
  await expect(page).toHaveURL('/dashboard');
});
```

## Edge Cases & Considerations

### Error Handling
- **Invalid credentials**: Clear error messages without revealing user existence
- **Email already exists**: Suggest sign-in instead of sign-up
- **Organization not found**: Graceful fallback to organization selection
- **Token expiration**: Automatic refresh or redirect to login

### Loading States
- **Authentication**: Skeleton loader for session validation
- **Organization switching**: Loading indicator during tenant resolution
- **Form submission**: Disabled state with spinner

### Empty States
- **No organizations**: Onboarding flow for first organization
- **No team members**: Invitation flow for collaboration
- **No permissions**: Clear explanation of access limitations

### Permission Checks
- **Route-level**: Middleware validation for protected routes
- **Component-level**: Conditional rendering based on permissions
- **API-level**: Server-side validation for all mutations

### Rate Limiting
- **Login attempts**: 5 attempts per 15 minutes per IP
- **Magic link requests**: 3 requests per hour per email
- **Organization creation**: 1 per hour per user

### Security Concerns
- **CSRF protection**: Token-based validation for all mutations
- **XSS prevention**: Input sanitization and CSP headers
- **SQL injection**: Parameterized queries only
- **Session hijacking**: Secure cookie settings and token rotation

## Performance Optimization

### Code Splitting
```typescript
// Dynamic imports for auth components
const LoginForm = dynamic(() => import('./login-form'), {
  loading: () => <AuthSkeleton />
});

const OAuthProviders = dynamic(() => import('./oauth-providers'), {
  ssr: false // Client-side only for OAuth
});
```

### Caching Layers
```typescript
// Redis caching for session data
const getCachedSession = async (token: string) => {
  const cached = await redis.get(`session:${token}`);
  return cached ? JSON.parse(cached) : null;
};

// Database query caching
const getOrganization = async (id: string) => {
  const cacheKey = `org:${id}`;
  const cached = await redis.get(cacheKey);
  if (cached) return JSON.parse(cached);
  
  const org = await db.organization.findUnique({ where: { id } });
  await redis.setex(cacheKey, 300, JSON.stringify(org)); // 5min cache
  return org;
};
```

### Database Query Optimization
```sql
-- Optimized queries with proper indexes
SELECT o.*, om.role, om.permissions 
FROM organizations o
JOIN organization_members om ON o.id = om.organization_id
WHERE om.user_id = $1 AND om.role IN ('owner', 'admin', 'editor');

-- Use covering indexes for common queries
CREATE INDEX idx_org_members_user_role ON organization_members(user_id, role) 
INCLUDE (organization_id, permissions);
```

### Asset Optimization
- **Images**: Next.js Image component with WebP format
- **Fonts**: Self-hosted fonts with font-display: swap
- **CSS**: Tailwind CSS purging for minimal bundle size

## Acceptance Criteria

### Functional Requirements
- ✅ Users can sign up with email/password
- ✅ Users can sign in with email/password or OAuth
- ✅ Users can create and manage organizations
- ✅ Users can invite team members with specific roles
- ✅ Tenant resolution works for subdomains and custom domains
- ✅ Role-based access control prevents unauthorized access

### Performance Benchmarks
- **Page load time**: < 2 seconds for auth pages
- **API response time**: < 500ms for auth endpoints
- **Database queries**: < 100ms for tenant resolution
- **Bundle size**: < 100KB for auth-related JavaScript

### User Experience Requirements
- **Accessibility**: WCAG 2.1 AA compliance
- **Mobile responsiveness**: Works on all device sizes
- **Error messages**: Clear, actionable feedback
- **Loading states**: Smooth transitions without layout shift

### Security Requirements
- **Password security**: Bcrypt with salt rounds ≥ 12
- **Session security**: HTTP-only cookies with secure flag
- **CSRF protection**: Valid tokens for all mutations
- **Rate limiting**: Prevents brute force attacks

## Migration Path

### Backward Compatibility
- **Existing users**: Seamless migration to new auth system
- **API compatibility**: Maintain existing endpoints during transition
- **Data preservation**: No data loss during migration

### Data Migration Steps
```sql
-- Migrate existing users to new schema
INSERT INTO users (id, email, name, created_at)
SELECT id, email, name, created_at FROM old_users;

-- Migrate organizations
INSERT INTO organizations (id, name, slug, created_at)
SELECT id, name, slug, created_at FROM old_organizations;

-- Migrate memberships
INSERT INTO organization_members (organization_id, user_id, role, joined_at)
SELECT organization_id, user_id, role, joined_at FROM old_memberships;
```

### Feature Flagging Strategy
```typescript
// Feature flags for gradual rollout
const FEATURE_FLAGS = {
  NEW_AUTH_SYSTEM: process.env.NEXT_PUBLIC_NEW_AUTH === 'true',
  OAUTH_PROVIDERS: process.env.NEXT_PUBLIC_OAUTH_ENABLED === 'true',
  MAGIC_LINKS: process.env.NEXT_PUBLIC_MAGIC_LINKS === 'true'
};

// Conditional rendering based on flags
{FEATURE_FLAGS.NEW_AUTH_SYSTEM && <NewAuthForm />}
```

## Timeline Estimation

### Phase 1: Core Multi-Tenancy (4-6 weeks)
- Week 1-2: Database schema and migrations
- Week 3-4: Tenant resolution middleware
- Week 5-6: Basic authentication and organization management

### Phase 2: Enhanced Authentication (3-4 weeks)
- Week 1-2: OAuth providers integration
- Week 3: Magic link authentication
- Week 4: Role-based access control

### Phase 3: Advanced Features (4-5 weeks)
- Week 1-2: Custom domain mapping
- Week 3: SSL certificate management
- Week 4-5: Advanced permissions and audit logging

**Total Estimated Timeline: 11-15 weeks**

## Success Metrics

### Technical Metrics
- **Uptime**: 99.9% availability
- **Response time**: < 500ms for auth operations
- **Error rate**: < 0.1% for authentication flows
- **Security**: Zero security incidents

### Business Metrics
- **User adoption**: 80% of users using new auth system within 30 days
- **Team collaboration**: 60% of organizations have multiple members
- **Custom domains**: 40% of organizations using custom domains
- **User satisfaction**: 4.5+ rating for authentication experience

This implementation plan provides a comprehensive roadmap for building a robust, scalable, and secure multi-tenancy and authentication system that serves as the foundation for the entire creator economy platform.
